<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo ‚Äî Propulsor Journey</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="/assets/propulsor-banner.png" alt="Propulsor Journey" style="width:100%; opacity:0.9">
            </div>
            <div class="sidebar-user">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-name" id="userName">Administrador</div>
                <div class="user-role admin">Administrativo</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Estad√≠sticas</div>
                <a class="nav-item active" onclick="showSection('stats')" href="#">
                    <span class="icon">üìä</span> Panel General
                </a>
                <div class="nav-section-title" style="margin-top:8px">Listados</div>
                <a class="nav-item" onclick="showSection('students-list')" href="#">
                    <span class="icon">üë•</span> Estudiantes
                </a>
                <a class="nav-item" onclick="showSection('teachers-list')" href="#">
                    <span class="icon">üë©‚Äçüè´</span> Docentes
                </a>
                </a>
                <div class="nav-section-title" style="margin-top:8px">Gesti√≥n</div>
                <a class="nav-item" onclick="showSection('management')" href="#">
                    <span class="icon">‚öôÔ∏è</span> Gesti√≥n de Datos
                </a>
                <div class="nav-section-title" style="margin-top:8px">Reportes</div>
                <a class="nav-item" onclick="downloadAdminPDF()" href="#">
                    <span class="icon">üìÑ</span> Informe General PDF
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Section: Stats -->
            <div id="section-stats">
                <div class="page-header">
                    <div class="page-title">üìä Panel General Administrativo</div>
                    <div class="page-subtitle">Estad√≠sticas acad√©micas en tiempo real</div>
                </div>

                <div class="welcome-banner">
                    <div class="welcome-greeting">Panel de Control</div>
                    <div class="welcome-name">Administrador del Sistema</div>
                    <div class="welcome-program">Universidad Externado de Colombia ¬∑ Propulsor Journey</div>
                </div>

                <!-- KPIs -->
                <div class="kpi-grid" id="adminKpis">
                    <div class="kpi-card">
                        <div class="kpi-icon red">üéì</div>
                        <div>
                            <div class="kpi-value" id="kpiStudents">‚Äî</div>
                            <div class="kpi-label">Estudiantes</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon blue">üë®‚Äçüè´</div>
                        <div>
                            <div class="kpi-value" id="kpiTeachers">‚Äî</div>
                            <div class="kpi-label">Docentes</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon green">üìö</div>
                        <div>
                            <div class="kpi-value" id="kpiPrograms">‚Äî</div>
                            <div class="kpi-label">Programas</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon yellow">üìà</div>
                        <div>
                            <div class="kpi-value" id="kpiAvg">‚Äî</div>
                            <div class="kpi-label">Promedio General</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon green">‚úÖ</div>
                        <div>
                            <div class="kpi-value" id="kpiPass">‚Äî%</div>
                            <div class="kpi-label">Tasa de Aprobaci√≥n</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon blue">‚≠ê</div>
                        <div>
                            <div class="kpi-value" id="kpiEvals">‚Äî</div>
                            <div class="kpi-label">Evaluaciones Docentes</div>
                        </div>
                    </div>
                </div>

                <!-- Highlights -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px" id="highlightsGrid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üèÜ Destacados</div>
                        </div>
                        <div class="card-body" id="highlightsContent">
                            <div style="color:var(--gray-400);text-align:center;padding:20px">Cargando...</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Estudiantes por Programa</div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height:220px">
                                <canvas id="programChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Programs table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã Rendimiento por Programa</div>
                        <button class="btn btn-primary btn-sm" onclick="downloadAdminPDF()">üìÑ Informe PDF</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Programa</th>
                                    <th style="text-align:center">Estudiantes</th>
                                    <th style="text-align:center">Promedio</th>
                                    <th style="text-align:center">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="programsTable">
                                <tr>
                                    <td colspan="4" style="text-align:center;padding:32px;color:var(--gray-400)">
                                        Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subject averages chart -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <div class="card-title">üìâ Promedio por Materia</div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="subjectChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Students List -->
            <div id="section-students-list" style="display:none">
                <div class="page-header">
                    <div class="page-title">üë• Listado de Estudiantes</div>
                    <div class="page-subtitle" id="totalStudentsSub">Cargando...</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <div class="search-container" style="flex:1; margin-bottom:0;">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="searchStudents"
                            placeholder="Buscar estudiante por nombre o usuario..." onkeyup="filterStudents()">
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()" style="margin-left:12px">üìä Exportar
                        Excel</button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Programa</th>
                                    <th style="text-align:center">Fallas</th>
                                    <th style="text-align:center">Promedio</th>
                                    <th style="text-align:center">Estado</th>
                                    <th style="text-align:right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="adminStudentsTable">
                                <tr>
                                    <td colspan="7" style="text-align:center;padding:32px">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section: Teachers List -->
            <div id="section-teachers-list" style="display:none">
                <div class="page-header">
                    <div class="page-title">üë©‚Äçüè´ Listado de Docentes</div>
                    <div class="page-subtitle" id="totalTeachersSub">Cargando...</div>
                </div>
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchTeachers"
                        placeholder="Buscar docente por nombre, usuario o programa..." onkeyup="filterTeachers()">
                </div>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Programas</th>
                                    <th>Estudiantes</th>
                                    <th style="text-align:right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="adminTeachersTable">
                                <tr>
                                    <td colspan="5" style="text-align:center;padding:32px">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal for Teacher Evaluations -->
            <div id="evaluationModal" class="modal" style="display:none">
                <div class="modal-content card">
                    <div class="card-header">
                        <div class="card-title">‚≠ê Resultados de Evaluaci√≥n: <span id="modalTeacherName"></span></div>
                        <button class="btn btn-secondary btn-sm" onclick="closeModal()">‚úï</button>
                    </div>
                    <div class="card-body">
                        <div class="kpi-grid">
                            <div class="kpi-card" style="padding:15px">
                                <div class="kpi-value" id="modalOverallAvg">‚Äî</div>
                                <div class="kpi-label">Promedio Global</div>
                            </div>
                            <div class="kpi-card" style="padding:15px">
                                <div class="kpi-value" id="modalTotalEvals">‚Äî</div>
                                <div class="kpi-label">Evaluaciones</div>
                            </div>
                        </div>
                        <div id="modalQuestionStats" style="margin-top:20px"></div>
                    </div>
                </div>
            </div>

            <!-- Section: Management -->
            <div id="section-management" style="display:none">
                <div class="page-header">
                    <div class="page-title">‚öôÔ∏è Gesti√≥n de Datos</div>
                    <div class="page-subtitle">Administra los datos del sistema acad√©mico</div>
                </div>

                <div class="card"
                    style="margin-bottom:20px; border: 2px dashed var(--green-inst-border); background: #f0f7f4;">
                    <div class="card-header" style="background: transparent">
                        <div class="card-title">üöÄ Portal de Carga Masiva (Excel)</div>
                    </div>
                    <div class="card-body" style="text-align:center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <h3 style="margin-bottom: 10px; color: var(--green-inst-dark)">Actualizar Base de Datos</h3>
                        <p
                            style="font-size:14px;color:var(--gray-600);margin-bottom:24px; max-width: 500px; margin-left: auto; margin-right: auto;">
                            Selecciona el archivo maestro de Excel para actualizar estudiantes, docentes y programas.
                            <strong>Nota:</strong> Esta acci√≥n sobrescribir√° los datos actuales.
                        </p>
                        <div style="display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none"
                                onchange="uploadExcel()">
                            <button class="btn btn-primary btn-lg"
                                onclick="document.getElementById('excelFile').click()">
                                üìÅ Seleccionar y Cargar Excel
                            </button>
                        </div>
                        <div id="uploadStatus" style="margin-top:16px; font-weight: 600;"></div>
                    </div>
                </div>

                <!-- Clear Data -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üóëÔ∏è Limpiar Datos</div>
                    </div>
                    <div class="card-body">
                        <p style="font-size:14px;color:var(--gray-600);margin-bottom:20px">
                            Limpia datos espec√≠ficos del sistema. Esta acci√≥n no puede deshacerse.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                            <div class="card" style="border:1px solid #fee2e2">
                                <div class="card-body" style="text-align:center;padding:20px">
                                    <div style="font-size:32px;margin-bottom:8px">üìä</div>
                                    <div style="font-weight:600;margin-bottom:4px">Notas</div>
                                    <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px">Limpia las
                                        notas modificadas</div>
                                    <button class="btn btn-danger btn-sm" onclick="clearData('notes')">Limpiar
                                        Notas</button>
                                </div>
                            </div>
                            <div class="card" style="border:1px solid #fee2e2">
                                <div class="card-body" style="text-align:center;padding:20px">
                                    <div style="font-size:32px;margin-bottom:8px">‚≠ê</div>
                                    <div style="font-weight:600;margin-bottom:4px">Evaluaciones</div>
                                    <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px">Limpia todas
                                        las evaluaciones</div>
                                    <button class="btn btn-danger btn-sm" onclick="clearData('evaluations')">Limpiar
                                        Evaluaciones</button>
                                </div>
                            </div>
                            <div class="card" style="border:1px solid #fee2e2">
                                <div class="card-body" style="text-align:center;padding:20px">
                                    <div style="font-size:32px;margin-bottom:8px">‚úÖ</div>
                                    <div style="font-weight:600;margin-bottom:4px">Asistencia</div>
                                    <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px">Reinicia
                                        registros de asistencia</div>
                                    <button class="btn btn-danger btn-sm" onclick="clearData('attendance')">Limpiar
                                        Asistencia</button>
                                </div>
                            </div>
                            <div class="card" style="border:2px solid #dc2626">
                                <div class="card-body" style="text-align:center;padding:20px">
                                    <div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div>
                                    <div style="font-weight:600;margin-bottom:4px">Todo</div>
                                    <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px">Limpia todos
                                        los datos del sistema</div>
                                    <button class="btn btn-danger btn-sm" onclick="clearData('all')">Limpiar
                                        Todo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="loading-spinner-large"></div>
            <div style="font-size:15px;font-weight:600;color:var(--gray-700)">Cargando...</div>
        </div>
    </div>

    <script>
        let statsData = null;
        let programChart = null;
        let subjectChart = null;
        let allStudents = [];
        let allTeachers = [];

        async function init() {
            try {
                const meRes = await fetch('/api/me');
                if (!meRes.ok) { window.location.href = '/'; return; }
                const me = await meRes.json();
                if (me.user.role !== 'administrativo') { window.location.href = '/'; return; }
                document.getElementById('userAvatar').textContent = me.user.nombre.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = me.user.nombre;

                await loadStats();
                await populateSelects();
                await loadAdminUsers();
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (e) {
                window.location.href = '/';
            }
        }

        async function loadAdminUsers() {
            const res = await fetch('/api/admin/users');
            if (!res.ok) return;
            const data = await res.json();

            allStudents = data.students;
            allTeachers = data.teachers;
            renderStudentsTable(allStudents);
            renderTeachersTable(allTeachers);
        }

        function renderStudentsTable(students) {
            const studentTable = document.getElementById('adminStudentsTable');
            studentTable.innerHTML = students.map(s => {
                const results = calculateStudentAvg(s);
                const fallas = s.attendanceStats ? s.attendanceStats.totalFallas : 0;
                const isForgiven = s.attendanceStats ? s.attendanceStats.isForgiven : false;

                const avgNum = results.avg !== null ? parseFloat(results.avg) : 0;
                const isFailingByGrades = results.avg !== null && avgNum < 3.0;
                const isFailingByAttendance = fallas > 0 && !isForgiven;
                const isReprobated = isFailingByGrades || isFailingByAttendance;

                let statusBadge = '<span class="badge badge-success">Aprobado</span>';
                if (isFailingByGrades && isFailingByAttendance) {
                    statusBadge = '<span class="badge badge-danger">Reprobado (Notas/Fallas)</span>';
                } else if (isFailingByGrades) {
                    statusBadge = '<span class="badge badge-warning">Reprobado (Notas)</span>';
                } else if (isFailingByAttendance) {
                    statusBadge = '<span class="badge badge-danger">Reprobado (Fallas)</span>';
                }

                return `
                    <tr>
                        <td><code>${s.username}</code></td>
                        <td><strong>${s.nombre}</strong></td>
                        <td><span class="badge badge-gray">${s.programa}</span></td>
                        <td style="text-align:center">
                            <span class="badge ${fallas > 0 ? (isForgiven ? 'badge-info' : 'badge-red') : 'badge-gray'}">
                                ${fallas} ${isForgiven ? '(Perdonadas)' : ''}
                            </span>
                        </td>
                        <td style="text-align:center"><strong style="color:${avgNum >= 3.0 ? 'var(--green-inst)' : 'var(--red)'}">${results.avg || 'N/A'}</strong></td>
                        <td style="text-align:center">${statusBadge}</td>
                        <td style="text-align:right">
                            ${isFailingByAttendance ? `<button class="btn btn-success btn-sm" onclick="pardonAttendance('${s.username}')" title="Aprobar por Fallas">‚úÖ Aprobar Fallas</button>` : ''}
                            ${isFailingByGrades ? `<button class="btn btn-warning btn-sm" onclick="overrideStudentGrade('${s.username}')" title="Aprobar por Notas">üìù Ajustar Notas</button>` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="downloadStudentPDF('${s.username}')">üìÑ PDF</button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="7" style="text-align:center;padding:32px">No se encontraron estudiantes</td></tr>';
        }

        async function overrideStudentGrade(username) {
            const student = allStudents.find(s => s.username === username);
            if (!student) return;

            // Find reprobate materias
            const reprobates = student.materias.filter(m => m.nota !== null && parseFloat(m.nota) < 3.0);
            if (!reprobates.length) return showToast('El estudiante no tiene materias reprobadas con nota registrada', 'info');

            if (!confirm(`¬øDeseas aprobar manualmente las ${reprobates.length} materias reprobadas de ${student.nombre} con nota 3.0?`)) return;

            showToast('‚è≥ Aplicando cambios...', 'info');
            try {
                for (const m of reprobates) {
                    await fetch('/api/admin/override-grade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentUser: username, materia: m.materia, nota: 3.0 })
                    });
                }
                showToast('‚úÖ Estudiante aprobado correctamente', 'success');
                await loadAdminUsers();
                await loadStats();
            } catch (e) {
                showToast('Error al actualizar notas', 'error');
            }
        }

        async function pardonAttendance(username) {
            if (!confirm(`¬øDeseas perdonar las inasistencias de ${username} para que pueda aprobar?`)) return;

            showToast('‚è≥ Aplicando perd√≥n...', 'info');
            try {
                const res = await fetch('/api/admin/override-attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentUser: username, status: true })
                });
                if (res.ok) {
                    showToast('‚úÖ Asistencia aprobada', 'success');
                    await loadAdminUsers();
                }
            } catch (e) {
                showToast('Error al conectar con el servidor', 'error');
            }
        }

        async function exportToExcel() {
            showToast('‚è≥ Preparando Excel...', 'info');
            window.location.href = '/api/admin/export-excel';
        }

        function renderTeachersTable(teachers) {
            const table = document.getElementById('adminTeachersTable');
            const tagClasses = ['tag-blue', 'tag-green', 'tag-purple', 'tag-orange', 'tag-pink', 'tag-indigo'];

            table.innerHTML = teachers.map(t => {
                // Sort programs alphabetically
                const sortedPrograms = (t.programas || []).sort((a, b) => a.localeCompare(b));

                const programsHtml = sortedPrograms.map((p, i) => {
                    const tagClass = tagClasses[i % tagClasses.length];
                    return `<span class="program-tag ${tagClass}">${p}</span>`;
                }).join('');

                return `
                <tr>
                    <td><code>${t.username}</code></td>
                    <td><strong style="font-size:1.1em">${t.nombre}</strong></td>
                    <td style="padding: 12px 14px">
                        <div class="program-tag-list">${programsHtml}</div>
                    </td>
                    <td style="text-align:center"><span class="badge badge-gray">${t.estudiantes ? t.estudiantes.length : 0}</span></td>
                    <td style="text-align:right">
                        <button class="btn btn-secondary btn-sm" onclick="viewEvaluations('${t.username}')">‚≠ê Eval</button>
                        <button class="btn btn-secondary btn-sm" onclick="showSection('teacher-view'); document.getElementById('teacherSelect').value='${t.username}'; loadTeacherView();">üëÅÔ∏è Ver</button>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center;padding:32px">No se encontraron docentes</td></tr>';
        }

        function filterStudents() {
            const query = document.getElementById('searchStudents').value.toLowerCase();
            const filtered = allStudents.filter(s =>
                s.nombre.toLowerCase().includes(query) ||
                s.username.toLowerCase().includes(query) ||
                s.programa.toLowerCase().includes(query)
            );
            renderStudentsTable(filtered);
        }

        function filterTeachers() {
            const query = document.getElementById('searchTeachers').value.toLowerCase();
            const filtered = allTeachers.filter(t =>
                t.nombre.toLowerCase().includes(query) ||
                t.username.toLowerCase().includes(query) ||
                (t.programas || []).some(p => p.toLowerCase().includes(query))
            );
            renderTeachersTable(filtered);
        }

        async function viewEvaluations(teacherUser) {
            const res = await fetch(`/api/admin/teacher-evaluations/${teacherUser}`);
            if (!res.ok) return showToast('Error al cargar evaluaciones', 'error');
            const data = await res.json();

            document.getElementById('modalTeacherName').textContent = data.teacherName;
            document.getElementById('modalOverallAvg').textContent = data.overallAvg;
            document.getElementById('modalTotalEvals').textContent = data.totalEvaluations;

            const statsContainer = document.getElementById('modalQuestionStats');
            statsContainer.innerHTML = data.questionStats.map((q, i) => {
                const pct = q.avg !== 'N/A' ? (parseFloat(q.avg) / 5 * 100).toFixed(0) : 0;
                const color = parseFloat(q.avg) >= 4 ? 'var(--green-inst)' : parseFloat(q.avg) >= 3 ? 'var(--yellow)' : 'var(--red)';
                return `
                    <div style="margin-bottom:15px">
                        <div style="font-size:13px; font-weight:600; margin-bottom:5px">${i + 1}. ${q.pregunta}</div>
                        <div style="display:flex; align-items:center; gap:10px">
                            <div class="progress-bar" style="flex:1">
                                <div class="progress-fill" style="width:${pct}%; background:${color}"></div>
                            </div>
                            <span style="font-weight:bold; width:35px">${q.avg}</span>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center; padding:20px">No hay evaluaciones para este docente.</p>';

            document.getElementById('evaluationModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('evaluationModal').style.display = 'none';
        }

        function calculateStudentAvg(student) {
            if (!student.materias || !student.materias.length) return { avg: null };
            const withNotes = student.materias.filter(m => m.nota !== null && !isNaN(m.nota));
            const avg = withNotes.length ? (withNotes.reduce((s, m) => s + parseFloat(m.nota), 0) / withNotes.length).toFixed(2) : null;
            return { avg };
        }

        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            if (!res.ok) return;
            statsData = await res.json();

            document.getElementById('kpiStudents').textContent = statsData.totalStudents;
            document.getElementById('kpiTeachers').textContent = statsData.totalTeachers;
            document.getElementById('kpiPrograms').textContent = statsData.totalPrograms;
            document.getElementById('kpiAvg').textContent = statsData.overallAvg || 'N/A';
            document.getElementById('kpiPass').textContent = statsData.passRate + '%';
            document.getElementById('kpiEvals').textContent = statsData.totalEvaluations;

            // Highlights
            const highlights = document.getElementById('highlightsContent');
            highlights.innerHTML = `
        ${statsData.bestSubject ? `<div class="alert alert-success" style="margin-bottom:10px">üìà <strong>Mejor materia:</strong> ${statsData.bestSubject.name} (${statsData.bestSubject.avg})</div>` : ''}
        ${statsData.worstSubject ? `<div class="alert alert-warning" style="margin-bottom:10px">üìâ <strong>Materia en riesgo:</strong> ${statsData.worstSubject.name} (${statsData.worstSubject.avg})</div>` : ''}
        ${statsData.bestTeacher ? `<div class="alert alert-info">‚≠ê <strong>Mejor docente:</strong> ${statsData.bestTeacher.name} (${statsData.bestTeacher.avg}/5)</div>` : ''}
        ${!statsData.bestSubject && !statsData.worstSubject ? '<div style="color:var(--gray-400);text-align:center;padding:20px">Sin datos suficientes</div>' : ''}
      `;

            // Programs table
            const tbody = document.getElementById('programsTable');
            const programs = Object.entries(statsData.byProgram);
            tbody.innerHTML = programs.map(([prog, d]) => {
                const avg = d.avg ? parseFloat(d.avg) : null;
                const badgeClass = avg === null ? 'badge-gray' : avg >= 3.5 ? 'badge-success' : avg >= 3.0 ? 'badge-warning' : 'badge-danger';
                const badgeText = avg === null ? 'Sin datos' : avg >= 3.0 ? 'Satisfactorio' : 'En riesgo';
                return `<tr>
          <td><strong>${prog}</strong></td>
          <td style="text-align:center">${d.count}</td>
          <td style="text-align:center;font-weight:700;color:${avg >= 3.5 ? '#16a34a' : avg >= 3.0 ? '#d97706' : '#dc2626'}">${d.avg || 'N/A'}</td>
          <td style="text-align:center"><span class="badge ${badgeClass}">${badgeText}</span></td>
        </tr>`;
            }).join('') || '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--gray-400)">Sin datos</td></tr>';

            renderProgramChart(programs);
            renderSubjectChart(statsData.subjectAvgs || []);
        }

        function renderProgramChart(programs) {
            const ctx = document.getElementById('programChart').getContext('2d');
            if (programChart) programChart.destroy();

            // Sort programs by count for better visualization in bar chart
            const sortedPrograms = [...programs].sort((a, b) => b[1].count - a[1].count);

            programChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPrograms.map(([p]) => p.length > 25 ? p.substring(0, 25) + '...' : p),
                    datasets: [{
                        label: 'Estudiantes',
                        data: sortedPrograms.map(([, d]) => d.count),
                        backgroundColor: 'rgba(0, 75, 50, 0.8)',
                        borderColor: '#004b32',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { grid: { color: '#f1f3f5' }, ticks: { stepSize: 1 } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderSubjectChart(subjectAvgs) {
            const ctx = document.getElementById('subjectChart').getContext('2d');
            if (subjectChart) subjectChart.destroy();
            const top = subjectAvgs.slice(0, 10);
            subjectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top.map(s => s.name),
                    datasets: [{
                        label: 'Promedio',
                        data: top.map(s => parseFloat(s.avg)),
                        backgroundColor: top.map(s => parseFloat(s.avg) >= 3.5 ? '#16a34a' : parseFloat(s.avg) >= 3.0 ? '#d97706' : '#dc2626'),
                        borderRadius: 8, borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0, max: 5, grid: { color: '#f1f3f5' }, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        async function populateSelects() {
            // Populate student select
            const gradesRes = await fetch('/api/admin/stats');
            if (!gradesRes.ok) return;
            const data = await gradesRes.json();

            // We'll use the stats to get student list - fetch from a different endpoint
            // For now, populate from known data
            const studentSelect = document.getElementById('studentSelect');
            const teacherSelect = document.getElementById('teacherSelect');

            // Fetch teacher info to get student list
            const teacherRes = await fetch('/api/teacher/info');
            if (teacherRes.ok) {
                const tData = await teacherRes.json();
                tData.estudiantes.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.usuario;
                    opt.textContent = `${s.nombre} (${s.usuario})`;
                    studentSelect.appendChild(opt);
                });
            }
        }

        async function loadStudentView() {
            const username = document.getElementById('studentSelect').value;
            if (!username) return;
            const container = document.getElementById('studentViewContent');
            container.innerHTML = '<div class="empty-state"><div class="loading-spinner-large" style="margin:0 auto"></div></div>';

            try {
                const res = await fetch(`/api/pdf/student/${username}`);
                // Just show a download button and basic info
                container.innerHTML = `
          <div class="card">
            <div class="card-body" style="text-align:center;padding:32px">
              <div style="font-size:48px;margin-bottom:12px">üéì</div>
              <h3 style="margin-bottom:8px">Estudiante: ${username}</h3>
              <p style="color:var(--gray-500);margin-bottom:20px">Descarga el reporte completo del estudiante</p>
              <button class="btn btn-primary" onclick="downloadStudentPDF('${username}')">üìÑ Descargar Reporte PDF</button>
            </div>
          </div>
        `;
            } catch (e) {
                container.innerHTML = '<div class="alert alert-danger">Error cargando datos del estudiante</div>';
            }
        }

        async function downloadStudentPDF(username) {
            showToast('‚è≥ Generando PDF...', 'info');
            const res = await fetch(`/api/pdf/student/${username}`);
            if (!res.ok) { showToast('Error generando PDF', 'error'); return; }
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte-${username}.pdf`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('‚úÖ PDF descargado', 'success');
        }

        function loadTeacherView() {
            const username = document.getElementById('teacherSelect').value;
            if (!username) return;
            document.getElementById('teacherViewContent').innerHTML = `
        <div class="card">
          <div class="card-body" style="text-align:center;padding:32px">
            <div style="font-size:48px;margin-bottom:12px">üë®‚Äçüè´</div>
            <h3 style="margin-bottom:8px">Docente: ${username}</h3>
            <p style="color:var(--gray-500);margin-bottom:20px">Vista del panel docente</p>
            <a href="/dashboard-teacher" class="btn btn-primary">üîó Ir al Panel Docente</a>
          </div>
        </div>
      `;
        }

        async function uploadExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;
            const status = document.getElementById('uploadStatus');
            status.textContent = '‚è≥ Subiendo archivo...';

            const formData = new FormData();
            formData.append('excel', file);

            try {
                const res = await fetch('/api/admin/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) {
                    status.textContent = `‚úÖ ${data.message} (${data.users} usuarios cargados)`;
                    showToast('‚úÖ Excel cargado correctamente', 'success');
                    await loadStats();
                } else {
                    status.textContent = `‚ùå ${data.error}`;
                    showToast('Error al cargar Excel', 'error');
                }
            } catch (e) {
                status.textContent = '‚ùå Error de conexi√≥n';
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function clearData(type) {
            const labels = { notes: 'notas', evaluations: 'evaluaciones', attendance: 'asistencia', all: 'todos los datos' };
            if (!confirm(`¬øEst√°s seguro de que deseas limpiar ${labels[type]}? Esta acci√≥n no puede deshacerse.`)) return;

            try {
                const res = await fetch('/api/admin/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(`‚úÖ ${data.message}`, 'success');
                    await loadStats();
                } else {
                    showToast('Error al limpiar datos', 'error');
                }
            } catch (e) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function downloadAdminPDF() {
            showToast('‚è≥ Generando informe general...', 'info');
            try {
                const res = await fetch('/api/pdf/admin');
                if (!res.ok) { showToast('Error generando PDF', 'error'); return; }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'informe-general-estadistico.pdf';
                a.click();
                URL.revokeObjectURL(url);
                showToast('‚úÖ Informe descargado', 'success');
            } catch (e) {
                showToast('Error al descargar informe', 'error');
            }
        }

        function showSection(name) {
            document.querySelectorAll('[id^="section-"]').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        init();
    </script>
</body>

</html>