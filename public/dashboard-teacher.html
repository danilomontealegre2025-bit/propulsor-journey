<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Docente ‚Äî Propulsor Journey</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="/assets/logo-propulsor.svg" alt="Propulsor Journey">
            </div>
            <div class="sidebar-user">
                <div class="user-avatar" id="userAvatar">D</div>
                <div class="user-name" id="userName">Cargando...</div>
                <div class="user-role">Docente</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" onclick="showSection('students')" href="#">
                    <span class="icon">üë•</span> Mis Estudiantes
                </a>
                <a class="nav-item" onclick="showSection('evaluations')" href="#">
                    <span class="icon">‚≠ê</span> Mis Evaluaciones
                </a>
                <div class="nav-section-title" style="margin-top:12px">Reportes</div>
                <a class="nav-item" onclick="downloadPDF()" href="#">
                    <span class="icon">üìÑ</span> Informe de Evaluaci√≥n PDF
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Section: Students & Attendance -->
            <div id="section-students">
                <div class="page-header">
                    <div class="page-title">üë• Mis Estudiantes</div>
                    <div class="page-subtitle" id="programasLabel">Cargando programas...</div>
                </div>

                <div class="welcome-banner">
                    <div class="welcome-greeting">Panel Docente</div>
                    <div class="welcome-name" id="welcomeName">Docente</div>
                    <div class="welcome-program" id="welcomePrograms">Cargando...</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon red">üë•</div>
                        <div>
                            <div class="kpi-value" id="kpiStudents">‚Äî</div>
                            <div class="kpi-label">Estudiantes</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon green">‚úÖ</div>
                        <div>
                            <div class="kpi-value" id="kpiPresentes">‚Äî</div>
                            <div class="kpi-label">Presentes hoy</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon yellow">‚≠ê</div>
                        <div>
                            <div class="kpi-value" id="kpiEvals">‚Äî</div>
                            <div class="kpi-label">Evaluaciones recibidas</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon blue">üìö</div>
                        <div>
                            <div class="kpi-value" id="kpiPrograms">‚Äî</div>
                            <div class="kpi-label">Programas</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã Lista de Estudiantes y Asistencia</div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-success btn-sm" onclick="markAll('presente')">‚úÖ Todos
                                Presentes</button>
                            <button class="btn btn-danger btn-sm" onclick="markAll('ausente')">‚ùå Todos Ausentes</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Programa</th>
                                    <th>Nota</th>
                                    <th>Asistencia</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="3" style="text-align:center;padding:32px;color:var(--gray-400)">
                                        Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section: Evaluations -->
            <div id="section-evaluations" style="display:none">
                <div class="page-header">
                    <div class="page-title">‚≠ê Mis Evaluaciones</div>
                    <div class="page-subtitle">Resultados de la evaluaci√≥n docente por parte de los estudiantes</div>
                </div>

                <div id="evalContent">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Cargando evaluaciones...</p>
                    </div>
                </div>

                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <div class="card-title">üìä Resultados por Criterio</div>
                        <button class="btn btn-primary btn-sm" onclick="downloadPDF()">üìÑ Descargar PDF</button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="evalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="loading-spinner-large"></div>
            <div style="font-size:15px;font-weight:600;color:var(--gray-700)">Cargando...</div>
        </div>
    </div>

    <script>
        let teacherData = null;
        let evalData = null;
        let evalChart = null;

        async function init() {
            try {
                const meRes = await fetch('/api/me');
                if (!meRes.ok) { window.location.href = '/'; return; }
                const me = await meRes.json();
                if (me.user.role !== 'docente' && me.user.role !== 'administrativo') { window.location.href = '/'; return; }

                document.getElementById('userAvatar').textContent = me.user.nombre.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = me.user.nombre;

                await loadTeacherData();
                await loadEvaluations();
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (e) {
                window.location.href = '/';
            }
        }

        async function loadTeacherData() {
            const res = await fetch('/api/teacher/info');
            if (!res.ok) return;
            teacherData = await res.json();

            document.getElementById('welcomeName').textContent = teacherData.nombre;
            document.getElementById('welcomePrograms').textContent = teacherData.programas.join(' ¬∑ ');
            document.getElementById('programasLabel').textContent = teacherData.programas.join(', ');

            const presentes = teacherData.estudiantes.filter(s => s.attendance === 'presente').length;
            document.getElementById('kpiStudents').textContent = teacherData.estudiantes.length;
            document.getElementById('kpiPresentes').textContent = presentes;
            document.getElementById('kpiPrograms').textContent = teacherData.programas.length;

            renderStudentsTable();
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            if (!teacherData.estudiantes.length) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:32px;color:var(--gray-400)">No hay estudiantes asignados</td></tr>';
                return;
            }
            tbody.innerHTML = teacherData.estudiantes.map(s => {
                // Find note for this teacher's subject if available
                // For simplicity, we assume the teacher is grading their primary assigned students from Excel
                // In a real app, we'd map this to a specific subject.
                const currentGrade = s.nota || '';

                return `
        <tr id="row-${s.usuario}">
          <td><strong>${s.nombre}</strong></td>
          <td><span class="badge badge-red">${s.programa}</span></td>
          <td>
            <input type="number" step="0.1" min="0" max="5" class="form-control" 
              style="width:80px; padding:4px 8px; text-align:center" 
              value="${currentGrade}" 
              onchange="updateGrade('${s.usuario}', this.value)">
          </td>
          <td>
            <div class="attendance-toggle">
              <button class="att-btn presente ${s.attendance === 'presente' ? 'active' : ''}"
                onclick="setAttendance('${s.usuario}', 'presente', this)">‚úÖ Presente</button>
              <button class="att-btn ausente ${s.attendance === 'ausente' ? 'active' : ''}"
                onclick="setAttendance('${s.usuario}', 'ausente', this)">‚ùå Ausente</button>
            </div>
          </td>
        </tr>
      `;
            }).join('');
        }

        async function updateGrade(studentUser, nota) {
            if (nota < 0 || nota > 5) {
                showToast('La nota debe estar entre 0 y 5', 'error');
                return;
            }
            try {
                // For simplicity, let's assume the first materia the student has with this teacher
                // We'll need to know which materia the teacher is grading.
                // In our mock data, est01 has 'Presupuestos' with doc01.
                // Let's find the materia name first.
                const student = teacherData.estudiantes.find(e => e.usuario === studentUser);
                // We'll use a generic approach: if we don't have the materia here, we'll try to find it in the API or just send the first one.
                // For this implementation, we'll assume the teacher grades "their" subject.

                // Let's just send the studentUser and the new grade, let the backend handle it if it knows the teacher-subject mapping, 
                // OR we can fetch student info first.
                const stdInfoRes = await fetch('/api/student/grades'); // This is student only... hmm.

                // Better approach: In a real app, teacher info should include student-materia mapping.
                // For now, let's use the first materia that matches this teacher.
                // We'll assume the backend handles the "primary" materia for this teacher.

                // Let's stick to the plan: POST /api/teacher/grade { studentUser, materia, nota }
                // We need the materia name.
                // Let's find it from the student data if we can, or just use a default for the teacher.

                // Actually, let's just use 'General' if we don't know, or better:
                // Let's assume the teacher handles one or more subjects.
                // In our sample data: doc01 -> Presupuestos.
                const materias = {
                    'doc01': 'Presupuestos',
                    'doc02': 'Dise√±o',
                    'doc03': 'Costos',
                    'doc04': 'Anal√≠tica',
                    'doc05': 'Normatividad'
                };
                const materiaName = materias[teacherData.username] || 'Materia';

                const res = await fetch('/api/teacher/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentUser, materia: materiaName, nota })
                });

                if (res.ok) {
                    showToast(`Nota guardada para ${studentUser}`, 'success');
                } else {
                    showToast('Error al guardar nota', 'error');
                }
            } catch (e) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function setAttendance(studentUser, status, btn) {
            try {
                await fetch('/api/teacher/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentUser, status })
                });
                // Update UI
                const row = document.getElementById(`row-${studentUser}`);
                row.querySelectorAll('.att-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // Update local data
                const student = teacherData.estudiantes.find(s => s.usuario === studentUser);
                if (student) student.attendance = status;
                const presentes = teacherData.estudiantes.filter(s => s.attendance === 'presente').length;
                document.getElementById('kpiPresentes').textContent = presentes;
                showToast(`Asistencia de ${student?.nombre || studentUser}: ${status}`, 'success');
            } catch (e) {
                showToast('Error al registrar asistencia', 'error');
            }
        }

        async function markAll(status) {
            const promises = teacherData.estudiantes.map(s =>
                fetch('/api/teacher/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentUser: s.usuario, status })
                })
            );
            await Promise.all(promises);
            teacherData.estudiantes.forEach(s => s.attendance = status);
            renderStudentsTable();
            const presentes = status === 'presente' ? teacherData.estudiantes.length : 0;
            document.getElementById('kpiPresentes').textContent = presentes;
            showToast(`Todos marcados como ${status}`, 'success');
        }

        async function loadEvaluations() {
            const res = await fetch('/api/teacher/evaluations');
            if (!res.ok) return;
            evalData = await res.json();

            document.getElementById('kpiEvals').textContent = evalData.evaluations.length;

            const container = document.getElementById('evalContent');
            if (!evalData.evaluations.length) {
                container.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è A√∫n no has recibido evaluaciones de los estudiantes.</div>';
                return;
            }

            // Calculate averages
            const qAvgs = evalData.questions.map(q => {
                const answers = evalData.evaluations.map(e => {
                    const a = e.answers.find(a => a.questionId == q.id);
                    return a ? parseFloat(a.value) : null;
                }).filter(v => v !== null);
                const avg = answers.length ? (answers.reduce((s, v) => s + v, 0) / answers.length).toFixed(2) : 'N/A';
                return { pregunta: q.pregunta, avg, count: answers.length };
            });

            const overallAvg = qAvgs.filter(q => q.avg !== 'N/A').length
                ? (qAvgs.filter(q => q.avg !== 'N/A').reduce((s, q) => s + parseFloat(q.avg), 0) / qAvgs.filter(q => q.avg !== 'N/A').length).toFixed(2)
                : 'N/A';

            container.innerHTML = `
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">üìä Resumen de Evaluaciones</div>
          </div>
          <div class="card-body">
            <div class="kpi-grid" style="margin-bottom:0">
              <div class="kpi-card">
                <div class="kpi-icon green">‚≠ê</div>
                <div><div class="kpi-value">${overallAvg}</div><div class="kpi-label">Promedio general</div></div>
              </div>
              <div class="kpi-card">
                <div class="kpi-icon blue">üë•</div>
                <div><div class="kpi-value">${evalData.evaluations.length}</div><div class="kpi-label">Evaluaciones</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìã Detalle por Criterio</div></div>
          <div class="card-body">
            ${qAvgs.map((q, i) => {
                const pct = q.avg !== 'N/A' ? (parseFloat(q.avg) / 5 * 100).toFixed(0) : 0;
                const color = parseFloat(q.avg) >= 4 ? '#16a34a' : parseFloat(q.avg) >= 3 ? '#d97706' : '#dc2626';
                return `<div style="margin-bottom:18px">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                  <span style="font-size:13px;color:var(--gray-700)">${i + 1}. ${q.pregunta}</span>
                  <strong style="color:${color};font-size:14px">${q.avg}/5</strong>
                </div>
                <div class="progress-bar" style="height:10px">
                  <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>
      `;

            renderEvalChart(qAvgs);
        }

        function renderEvalChart(qAvgs) {
            const ctx = document.getElementById('evalChart').getContext('2d');
            if (evalChart) evalChart.destroy();
            evalChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: qAvgs.map((q, i) => `Criterio ${i + 1}`),
                    datasets: [{
                        label: 'Promedio',
                        data: qAvgs.map(q => q.avg !== 'N/A' ? parseFloat(q.avg) : 0),
                        backgroundColor: 'rgba(139,0,0,0.15)',
                        borderColor: '#8B0000',
                        pointBackgroundColor: '#8B0000',
                        pointRadius: 5,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: { min: 0, max: 5, ticks: { stepSize: 1 }, grid: { color: '#eee' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function downloadPDF() {
            showToast('‚è≥ Generando PDF...', 'info');
            try {
                const res = await fetch('/api/pdf/teacher');
                if (!res.ok) { showToast('Error generando PDF', 'error'); return; }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'informe-evaluacion-docente.pdf';
                a.click();
                URL.revokeObjectURL(url);
                showToast('‚úÖ PDF descargado', 'success');
            } catch (e) {
                showToast('Error al descargar PDF', 'error');
            }
        }

        function showSection(name) {
            document.querySelectorAll('[id^="section-"]').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        init();
    </script>
</body>

</html>